{% extends 'base.html' %}
{% block title %}{{ product.friendly_name}} Bug{% endblock %}
{% block content %}
<div class="long-container">
  
  <div style="width: 80%; margin: 0px auto 2em auto; padding-left: 10%;">
  <div class="problem-box singlular sev{{ case.severity }} clearfix">
    <a class="dropin" title="{{ case.bug_name }}" href="bugs/{{ case.key.name }}">
      {{case.occurrence_count}}
      <span class="caption">{% ifequal case.occurrence_count 1 %}occurrence{% else %}occurrences{%endifequal%}</span>
    </a>
      <h2><a href="bugs/{{ case.key.name }}">
          {{ case.exception_name|escape }}
      </a></h2>
      <p>{{ case.exception_package|escape }}<br>
      {{ case.exception_klass|escape }}<span class="dim">.{{ case.exception_method|escape }} {{ case.exception_line }}</span></p>
    <p class="date">
      {% ifequal case.first_occurrence_on case.last_occurrence_on %}Occurred {{ case.first_occurrence_on|naturalday:"%b %d, %Y" }}{% else %}Occurring {{ case.first_occurrence_on|naturalday:"%b %d, %Y" }} till {{ case.last_occurrence_on|naturalday:"%b %d, %Y"}}{% endifequal %},
      4 clients affected.
    </p>
  </div>
  </div>

  <table style="width: 80%">
    <col width="230" />
    <tr>
      <td>Lighthouse ticket id</td>
      <td>{% if case.ticket %}<span id="ticket-display">#{{ case.ticket.name }} — <a href="#" onclick="$('#ticket-display').hide();$('#ticket-form').show().focus();return false;">change</a></span>{% endif %}<form id="ticket-form" action="assign-ticket" method="POST" {% if case.ticket %}style="display: none"{% endif %}><input name="ticket" value="{{ case.ticket.name }}"> <input type="submit" value="Assign"></form></td>
    </tr>
  </table>
  
    <!--
    <tr>
      <td>exception name</td>
      <td>{{ case.exception_name }}</td>
    </tr>
    <tr>
      <td>location</td>
      <td><p>{{ case.exception_package }}<br>
        {{ case.exception_location }} <span class="dim">{{ case.exception_line }}</span></p></td>
    </tr>
    <tr>
      <td>occurred</td>
      <td>{{ case.occurrence_count }} times &nbsp;{% ifequal case.first_occurrence_on case.last_occurrence_on %}{{ case.first_occurrence_on|naturalday:"%b %d, %Y"}} only{% else %}{{ case.first_occurrence_on|naturalday:"%b %d, %Y"}} – {{ case.last_occurrence_on|naturalday:"%b %d, %Y"}}{% endifequal %}</td>
    </tr>
  -->
  
  <h2>Stack trace</h2>
  <table style="width: 80%">
    <col width="230" />
    {% for exception in case.exceptions_list %}
      {% for location in exception.locations %}
        <tr class="{% cycle odd,even %}">
          <td>{% if forloop.first %}<small>{{ exception.name|escape }}</small>{% endif %}</td>
          <td class="evencol" style="text-align: right">{{ location.package|escape }}</td>
          <td>{{location.klass|escape}}<span class="dim">.{{location.method|escape}} {{location.line}}</span></td>
        </tr>
      {% endfor %}
    {% endfor %}
  </table>
  
  {% if env_items %}
    <h2>Environment</h2>
    <table style="width: 80%">
      <col width="230" />
      {% for item in env_items %}
        <tr class="{% cycle odd,even %}">
          <td>{{item.0|strip_prefix:"env_"}}</td>
          <td class="evencol">{% for v in item.1%}{% if not forloop.first %}, {% endif %}{{v|escape}}{%endfor%}</td>
        </tr>
      {% endfor %}
    </table>
  {% endif %}
  
  {% if common_data_items %}
    <h2>Common to all occurrences</h2>
    <table style="width: 80%">
      <col width="230" />
      {% for item in common_data_items %}
        <tr class="{% cycle odd,even %}">
          <td>{{item.0|strip_prefix:"data_"}}</td>
          <td class="evencol">{% for v in item.1%}{% if not forloop.first %}, {% endif %}{{v|escape}}{%endfor%}</td>
        </tr>
      {% endfor %}
    </table>
  {% endif %}
  
  <h2>Additional information</h2>
  
  <div class="table-scrolling-container">
  <table>
    <col width="80" />
    <col width="120" />
    <tr class="header">
      <th></th>
      <th>occurred</th>
      {% for key in data_keys %}<th valign="top">{{ key|strip_prefix:"data_"|strip_prefix:"env_" }}</th>{% endfor %}
    </tr>
    {% for occurrence in occurrences %}
      <tr class="{% cycle odd,even %}">
        <td class="oddcol"><big>{{occurrence.count}}</big> <span class="dim">{%ifequal occurrence.count 1%}occur.{%else%}occur.{%endifequal%}</span></td>
        <td class="date evencol">{{ occurrence.date|date:"N j, Y" }}</td>
        {% for key in data_keys %}<td class="{% if forloop.counter|divisibleby:2 %}evencol{%else%}oddcol{% endif %}" title="{{ occurrence|kgetattr:key|unshortened_tooltip:15}}">{{ occurrence|kgetattr:key|shorten:15|escape }}</td>{% endfor %}
      </tr>
    {% endfor %}
  </table>
  </div>
</div>

{% endblock %}
